<!DOCTYPE html>
<html lang="fa" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù¾Ù†Ù„ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø³Ø±ÙˆÛŒØ³ Ø§Ø¹ØªØ¨Ø§Ø±ÛŒ</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: Tahoma, sans-serif;
        }

        .card {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border: none;
            margin-bottom: 20px;
        }

        .nav-tabs .nav-link.active {
            font-weight: bold;
            color: #0d6efd;
        }
    </style>
</head>

<body class="p-4">

    <div class="container">
        <h3 class="mb-4 text-center">ğŸ›ï¸ Ù…Ø§Ú© Ø³Ø±ÙˆØ± Ø³Ø±ÙˆÛŒØ³ Ø§Ø¹ØªØ¨Ø§Ø±ÛŒ (Vandar Mock)</h3>

        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card p-3">
                    <h5>Ø«Ø¨Øª Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯</h5>
                    <input type="text" id="regUuid" class="form-control mb-2"
                        placeholder="Cardholder UUID (auto if empty)">
                    <input type="number" id="regAmount" class="form-control mb-2" placeholder="Ø§Ø¹ØªØ¨Ø§Ø± Ø§ÙˆÙ„ÛŒÙ‡ (Ø±ÛŒØ§Ù„)">
                    <button onclick="registerUser()" class="btn btn-primary w-100">Ø«Ø¨Øª Ù†Ø§Ù…</button>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card p-3">
                    <h5>Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø¹ØªØ¨Ø§Ø± (Adjustment)</h5>
                    <select id="adjUser" class="form-select mb-2"></select>
                    <input type="number" id="adjAmount" class="form-control mb-2" placeholder="Ù…Ø¨Ù„Øº">
                    <div class="d-flex gap-2">
                        <button onclick="adjustCredit('CREDIT')" class="btn btn-success flex-fill">Ø§ÙØ²Ø§ÛŒØ´ (+)</button>
                        <button onclick="adjustCredit('DEBIT')" class="btn btn-danger flex-fill">Ú©Ø§Ù‡Ø´ (-)</button>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card p-3 bg-light border-warning">
                    <h5>Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø®Ø±ÛŒØ¯ (ØªØ³Øª)</h5>
                    <select id="payUser" class="form-select mb-2"></select>
                    <input type="number" id="payAmount" class="form-control mb-2" placeholder="Ù…Ø¨Ù„Øº Ø®Ø±ÛŒØ¯">
                    <button onclick="simulatePayment()" class="btn btn-warning w-100">Ø§Ù†Ø¬Ø§Ù… Ø®Ø±ÛŒØ¯ Ø§Ø¹ØªØ¨Ø§Ø±ÛŒ</button>
                </div>
            </div>
        </div>

        <ul class="nav nav-tabs mb-3" id="myTab" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab"
                    data-bs-target="#accounts">Ø­Ø³Ø§Ø¨â€ŒÙ‡Ø§</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#logs">ØªØ§Ø±ÛŒØ®Ú†Ù‡
                    ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#payments">Ù„ÛŒØ³Øª
                    Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§</button></li>
        </ul>

        <div class="tab-content" id="myTabContent">
            <div class="tab-pane fade show active" id="accounts">
                <table class="table table-striped table-hover bg-white rounded">
                    <thead>
                        <tr>
                            <th>UUID</th>
                            <th>Ø´Ù…Ø§Ø±Ù‡ Ø­Ø³Ø§Ø¨</th>
                            <th>ÙˆØ¶Ø¹ÛŒØª</th>
                            <th>Ø§Ø¹ØªØ¨Ø§Ø± (Ø±ÛŒØ§Ù„)</th>
                            <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="accountsTable"></tbody>
                </table>
            </div>
            <div class="tab-pane fade" id="logs">
                <button onclick="loadLogs()" class="btn btn-sm btn-secondary mb-2">Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</button>
                <table class="table table-sm bg-white">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Ù†ÙˆØ¹</th>
                            <th>Ù…Ø¨Ù„Øº</th>
                            <th>ØªØ§Ø±ÛŒØ®</th>
                        </tr>
                    </thead>
                    <tbody id="logsTable"></tbody>
                </table>
            </div>
            <div class="tab-pane fade" id="payments">
                <button onclick="loadPayments()" class="btn btn-sm btn-secondary mb-2">Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</button>
                <table class="table table-sm bg-white">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Pay ID</th>
                            <th>Ù…Ø¨Ù„Øº</th>
                            <th>ØªØ§Ø±ÛŒØ® Ù¾Ø±Ø¯Ø§Ø®Øª</th>
                        </tr>
                    </thead>
                    <tbody id="paymentsTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/uuid@8.3.2/dist/umd/uuidv4.min.js"></script>
    <script>
        const API_BASE = '/v1/business/testbiz/ravand/provider/testprovider';

        async function loadAccounts() {
            const res = await fetch(`${API_BASE}/credit/account`);
            const json = await res.json();

            const tbody = document.getElementById('accountsTable');
            const userSelects = [document.getElementById('adjUser'), document.getElementById('payUser')];

            tbody.innerHTML = '';
            userSelects.forEach(s => s.innerHTML = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±...</option>');

            json.data.accounts.forEach(acc => {
                // Ù¾Ø± Ú©Ø±Ø¯Ù† Ø¬Ø¯ÙˆÙ„
                tbody.innerHTML += `
                <tr>
                    <td><small>${acc.cardholder_id}</small></td>
                    <td>${acc.account.account_number}</td>
                    <td><span class="badge bg-${acc.credit.status === 'ACTIVE' ? 'success' : 'secondary'}">${acc.credit.status}</span></td>
                    <td class="fw-bold text-primary">${acc.credit.balance.toLocaleString()}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-info" onclick="toggleStatus('${acc.cardholder_id}', '${acc.credit.status}')">ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª</button>
                    </td>
                </tr>
            `;
                // Ù¾Ø± Ú©Ø±Ø¯Ù† Ø³Ù„Ú©Øªâ€ŒÙ‡Ø§
                userSelects.forEach(s => {
                    s.innerHTML += `<option value="${acc.cardholder_id}">${acc.cardholder_id.substring(0, 8)}... (${acc.credit.balance})</option>`;
                });
            });
        }

        async function registerUser() {
            const id = document.getElementById('regUuid').value || uuidv4();
            const amount = document.getElementById('regAmount').value || 0;

            const res = await fetch(`${API_BASE}/cardholder/${id}/credit/register`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ credit_amount: parseInt(amount) })
            });
            const data = await res.json();
            alert(data.message);
            loadAccounts();
        }

        async function adjustCredit(type) {
            const id = document.getElementById('adjUser').value;
            const amount = document.getElementById('adjAmount').value;
            if (!id || !amount) return alert('Ú©Ø§Ø±Ø¨Ø± Ùˆ Ù…Ø¨Ù„Øº Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');

            const res = await fetch(`${API_BASE}/cardholder/${id}/credit/adjustment`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ credit_amount: parseInt(amount), type })
            });
            loadAccounts(); loadLogs();
        }

        async function simulatePayment() {
            const id = document.getElementById('payUser').value;
            const amount = document.getElementById('payAmount').value;
            if (!id || !amount) return alert('Ú©Ø§Ø±Ø¨Ø± Ùˆ Ù…Ø¨Ù„Øº Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');

            // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² API Ù…Ø®ÙÛŒ Ø¯ÛŒØ¨Ø§Ú¯
            const res = await fetch(`/api/debug/simulate-payment`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ cardholder_id: id, amount: parseInt(amount) })
            });
            const d = await res.json();
            alert(d.message);
            loadAccounts(); loadPayments();
        }

        async function toggleStatus(id, current) {
            const newStatus = current === 'ACTIVE' ? 'INACTIVE' : 'ACTIVE';
            await fetch(`${API_BASE}/cardholder/${id}/credit/update-status`, {
                method: 'PUT', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: newStatus })
            });
            loadAccounts();
        }

        async function loadLogs() {
            const res = await fetch(`${API_BASE}/credit`);
            const json = await res.json();
            document.getElementById('logsTable').innerHTML = json.data.credits.map(l => `
            <tr>
                <td><small>${l.cardholder_id.substring(0, 8)}...</small></td>
                <td><span class="badge bg-${l.type === 'CREDIT' ? 'success' : 'danger'}">${l.type}</span></td>
                <td>${l.credit_amount.toLocaleString()}</td>
                <td>${l.adjusted_at}</td>
            </tr>
        `).join('');
        }

        async function loadPayments() {
            const res = await fetch(`${API_BASE}/credit/payment`);
            const json = await res.json();
            document.getElementById('paymentsTable').innerHTML = json.data.payments.map(p => `
            <tr>
                <td><small>${p.cardholder_id.substring(0, 8)}...</small></td>
                <td>${p.pay_id}</td>
                <td>${p.amount.toLocaleString()}</td>
                <td>${p.paid_at}</td>
            </tr>
        `).join('');
        }

        // Init
        loadAccounts();
        loadLogs();
        loadPayments();
    </script>
</body>

</html>